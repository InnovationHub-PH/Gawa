import{g as p,d,a as P}from"./auth-DasK3Pgx.js";function v(){const t=new URLSearchParams(window.location.search).get("id");if(t)y(t);else{const n=p();n?y(n.id):setTimeout(()=>{const o=p();o?y(o.id):(c("Please sign in to view your profile"),setTimeout(()=>{window.location.href="index.html"},2e3))},1e3)}}async function y(e){const t=p(),n=t&&t.id===e;try{const{data:o,error:a}=await d.getProfile(e);if(a)throw a;if(!o){c("Profile not found");return}const{data:r,error:i}=await d.getUserPosts(e);if(i)throw i;const{data:s,error:m}=await d.getUserRatings(e);if(m)throw m;const{average:u,count:g}=await d.getUserAverageRating(e),{data:f}=await d.getFollowers(e),{data:l}=await d.getFollowing(e);let B=!1;if(t&&!n){const{data:E}=await d.isFollowing(t.id,e);B=E}I(o,r,s,u,g,(f==null?void 0:f.length)||0,(l==null?void 0:l.length)||0,n,B)}catch(o){console.error("Error loading profile:",o),c("Failed to load profile")}}function I(e,t,n,o,a,r,i,s,m){document.getElementById("profileAvatar").src=e.avatar_url||"https://innovationhub-ph.github.io/MakersClub/images/Stealth_No_Image.png",document.getElementById("profileName").textContent=e.full_name||e.username,document.getElementById("profileUsername").textContent=`@${e.username}`,document.getElementById("profileBio").textContent=e.bio||"No bio available",document.getElementById("profileLocation").textContent=e.location||"",document.getElementById("profileWebsite").href=e.website||"#",document.getElementById("profileWebsite").textContent=e.website||"",document.getElementById("postsCount").textContent=t.length,document.getElementById("followersCount").textContent=r,document.getElementById("followingCount").textContent=i,document.getElementById("averageRating").textContent=o.toFixed(1),document.getElementById("ratingCount").textContent=`(${a} reviews)`,b(o);const u=document.getElementById("followButton"),g=document.getElementById("editProfileButton"),f=document.getElementById("rateUserButton");if(s){u.style.display="none",f.style.display="none",g.style.display="block";const l=document.getElementById("uploadProfilePictureBtn");l&&(l.style.display="block")}else{g.style.display="none",u.style.display="block",f.style.display="block";const l=document.getElementById("uploadProfilePictureBtn");l&&(l.style.display="none"),u.textContent=m?"UNFOLLOW":"FOLLOW",u.dataset.following=m,u.dataset.userId=e.id}L(t),U(n)}function b(e){const t=document.getElementById("ratingStars");t.innerHTML="";for(let n=1;n<=5;n++){const o=document.createElement("span");o.className="star",o.textContent=n<=e?"★":"☆",t.appendChild(o)}}function L(e){const t=document.getElementById("postsContainer");if(e.length===0){t.innerHTML='<p class="no-posts">No posts yet</p>';return}t.innerHTML=e.map(n=>C(n)).join("")}function C(e){const t=w(new Date(e.created_at));return`
    <div class="post-card">
      <div class="post-header">
        <img src="${e.profiles.avatar_url||"https://innovationhub-ph.github.io/MakersClub/images/Stealth_No_Image.png"}" alt="${e.profiles.username}" class="post-avatar">
        <div class="post-info">
          <h4>${e.profiles.full_name||e.profiles.username}</h4>
          <span class="post-time">${t}</span>
        </div>
      </div>
      <div class="post-content">
        <h3>${e.title}</h3>
        <p>${e.content}</p>
        ${e.image_url?`<img src="${e.image_url}" alt="Post image" class="post-image">`:""}
      </div>
      <div class="post-tags">
        ${e.tags?e.tags.map(n=>`<span class="tag">${n.toUpperCase()}</span>`).join(""):""}
      </div>
    </div>
  `}function U(e){const t=document.getElementById("ratingsContainer");if(e.length===0){t.innerHTML='<p class="no-ratings">No reviews yet</p>';return}t.innerHTML=e.map(n=>$(n)).join("")}function $(e){const t=w(new Date(e.created_at)),n="★".repeat(e.rating)+"☆".repeat(5-e.rating);return`
    <div class="rating-card">
      <div class="rating-header">
        <img src="${e.profiles.avatar_url||"https://innovationhub-ph.github.io/MakersClub/images/Stealth_No_Image.png"}" alt="${e.profiles.username}" class="rating-avatar">
        <div class="rating-info">
          <h4>${e.profiles.full_name||e.profiles.username}</h4>
          <div class="rating-stars">${n}</div>
          <span class="rating-time">${t}</span>
        </div>
      </div>
      ${e.comment?`<p class="rating-comment">${e.comment}</p>`:""}
    </div>
  `}function x(){const e=document.getElementById("followButton");e&&e.addEventListener("click",F);const t=document.getElementById("rateUserButton");t&&t.addEventListener("click",_);const n=document.getElementById("editProfileButton");n&&n.addEventListener("click",N);const o=document.getElementById("profilePictureInput"),a=document.getElementById("uploadProfilePictureBtn");a&&o&&(a.addEventListener("click",()=>{o.click()}),o.addEventListener("change",M)),S(),R()}async function M(e){const t=e.target.files[0];if(!t)return;if(!t.type.startsWith("image/")){c("Please select an image file");return}if(t.size>5*1024*1024){c("Image must be smaller than 5MB");return}const n=p();if(!n){c("Please sign in to upload a profile picture");return}try{const o=document.getElementById("uploadProfilePictureBtn"),a=o.textContent;throw o.textContent="UPLOADING...",o.disabled=!0,new Error("Supabase not configured. Please set up your environment variables.");const r=new FileReader;r.onload=async function(i){try{const s=i.target.result,m=t.name.split(".").pop(),u=`${n.id}-${Date.now()}.${m}`,{data:g,error:f}=await d.uploadProfilePicture(u,t);let l;if(f)console.warn("Supabase Storage upload failed, using base64 fallback:",f),l=s;else{const{data:E}=await d.getProfilePictureUrl(u);l=(E==null?void 0:E.publicUrl)||s}await d.updateProfile(n.id,{avatar_url:l}),document.getElementById("profileAvatar").src=l;const B=document.getElementById("userAvatar");B&&(B.src=l),h("Profile picture updated successfully!")}catch(s){console.error("Error processing profile picture:",s),c("Failed to upload profile picture. Please try again.")}finally{const s=document.getElementById("uploadProfilePictureBtn");s.textContent=a,s.disabled=!1}},r.onerror=function(){c("Failed to read the image file");const i=document.getElementById("uploadProfilePictureBtn");i.textContent=a,i.disabled=!1},r.readAsDataURL(t)}catch(o){console.error("Error uploading profile picture:",o),c(`Failed to upload profile picture: ${o.message}`);const a=document.getElementById("uploadProfilePictureBtn");a.textContent=originalText,a.disabled=!1}}async function F(e){const t=p();if(!t){c("Please sign in to follow users");return}const n=e.target,o=n.dataset.userId,a=n.dataset.following==="true";try{a?(await d.unfollowUser(t.id,o),n.textContent="FOLLOW",n.dataset.following="false"):(await d.followUser(t.id,o),n.textContent="UNFOLLOW",n.dataset.following="true"),y(o)}catch(r){console.error("Error toggling follow:",r),c("Failed to update follow status")}}function _(){document.getElementById("ratingModal").classList.remove("hidden")}function S(){const e=document.getElementById("ratingModal"),t=document.getElementById("closeRatingModal"),n=document.getElementById("ratingForm"),o=document.querySelectorAll(".rating-star");let a=0;t.addEventListener("click",()=>{e.classList.add("hidden")}),o.forEach((r,i)=>{r.addEventListener("click",()=>{a=i+1,k(o,a)})}),n.addEventListener("submit",async r=>{r.preventDefault();const i=p();if(!i){c("Please sign in to rate users");return}const m=new URLSearchParams(window.location.search).get("id"),u=n.comment.value;try{await d.rateUser(i.id,m,a,u),e.classList.add("hidden"),h("Rating submitted successfully"),y(m)}catch(g){console.error("Error submitting rating:",g),c("Failed to submit rating")}})}function k(e,t){e.forEach((n,o)=>{n.classList.toggle("selected",o<t)})}function N(){const e=document.getElementById("editProfileModal"),t=P();document.getElementById("editFullName").value=t.full_name||"",document.getElementById("editUsername").value=t.username||"",document.getElementById("editBio").value=t.bio||"",document.getElementById("editLocation").value=t.location||"",document.getElementById("editWebsite").value=t.website||"",e.classList.remove("hidden")}function R(){const e=document.getElementById("editProfileModal"),t=document.getElementById("closeEditProfileModal"),n=document.getElementById("editProfileForm");t.addEventListener("click",()=>{e.classList.add("hidden")}),n.addEventListener("submit",async o=>{o.preventDefault();const a=p();if(!a)return;const r=new FormData(o.target),i={full_name:r.get("fullName"),username:r.get("username"),bio:r.get("bio"),location:r.get("location"),website:r.get("website")};try{await d.updateProfile(a.id,i),e.classList.add("hidden"),h("Profile updated successfully"),y(a.id)}catch(s){console.error("Error updating profile:",s),c("Failed to update profile")}})}function w(e){const n=Math.floor((new Date-e)/1e3);return n<60?"just now":n<3600?`${Math.floor(n/60)}m ago`:n<86400?`${Math.floor(n/3600)}h ago`:n<2592e3?`${Math.floor(n/86400)}d ago`:e.toLocaleDateString()}function c(e){alert(e)}function h(e){alert(e)}document.addEventListener("DOMContentLoaded",async()=>{v(),x()});
